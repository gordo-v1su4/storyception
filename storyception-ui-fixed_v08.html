<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STORYCEPTION | Cinematic Story Engine</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: JetBrains Mono -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        background: '#0a0a0a',
                        card: '#18181b',
                        border: '#27272a',
                        primary: '#f4f4f5',
                        secondary: '#a1a1aa',
                        muted: '#71717a',
                        cyan: {
                            DEFAULT: '#06b6d4',
                            dim: 'rgba(6,182,212,0.1)',
                            glow: 'rgba(6,182,212,0.3)',
                        },
                        teal: '#14b8a6',
                        yellow: '#fbbf24',
                    },
                    fontFamily: {
                        mono: ['"JetBrains Mono"', 'monospace'],
                    },
                    boxShadow: {
                        'glow': '0 0 15px rgba(6, 182, 212, 0.15)',
                        'modal': '0 8px 24px rgba(0,0,0,0.5)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0a0a0a;
            color: #f4f4f5;
            font-family: 'JetBrains Mono', monospace;
            overflow: hidden;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0a0a0a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #27272a; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #3f3f46; 
        }

        .hide-scroll::-webkit-scrollbar {
            display: none;
        }
        .hide-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Icons ---
        const Icons = {
            Film: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" /><path d="M7 3v18" /><path d="M3 7.5h4" /><path d="M3 12h18" /><path d="M3 16.5h4" /><path d="M17 3v18" /><path d="M17 7.5h4" /><path d="M17 16.5h4" /></svg>,
            Play: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="6 3 20 12 6 21 6 3" /></svg>,
            Shuffle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 18h1.4c1.3 0 2.5-.6 3.3-1.7l14.2-12.6c.8-1.1 2-1.7 3.3-1.7H22" /><path d="M2 6h1.4c1.3 0 2.5.6 3.3 1.7l14.2 12.6c.8 1.1 2 1.7 3.3 1.7H22" /></svg>,
            Plus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14" /><path d="M12 5v14" /></svg>,
            Minus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14" /></svg>,
            X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18" /><path d="m6 6 12 12" /></svg>,
            Check: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 6 9 17l-5-5" /></svg>,
            ChevronRight: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6" /></svg>,
            GitBranch: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="6" x2="6" y1="3" y2="15" /><circle cx="18" cy="6" r="3" /><circle cx="6" cy="18" r="3" /><path d="M18 9a9 9 0 0 1-9 9" /></svg>,
            Sparkles: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" /></svg>,
            Upload: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></svg>
        };

        const Icon = ({ name, size = 16, className = "", fill = "none" }) => {
            const IconComponent = Icons[name];
            if (!IconComponent) return null;
            return <IconComponent width={size} height={size} className={className} fill={fill} />;
        };

        // --- Mock Data ---
        // cSpell:ignore Morty
        const archetypes = [
            { title: "HERO'S JOURNEY", subtitle: "EPIC ENGINE", example: "Star Wars, Marvel", desc: "Mythic progression & world-building" },
            { title: "SAVE THE CAT", subtitle: "PACING ENGINE", example: "Pixar, Blockbusters", desc: "Structured beats for maximum engagement" },
            { title: "STORY CIRCLE", subtitle: "CHARACTER ENGINE", example: "Rick & Morty, Community", desc: "Cyclical change and return" },
            { title: "THREE-ACT", subtitle: "BASE ENGINE", example: "Standard Cinema", desc: "Setup, confrontation, resolution" },
            { title: "SEVEN-POINT", subtitle: "MILESTONE ENGINE", example: "Discovery Writers", desc: "Key turning points without rigid outline" },
            { title: "LESTER DENT", subtitle: "PULP FICTION ENGINE", example: "Pulp Fiction, Thrillers", desc: "Systematic escalation of trouble" },
        ];

        const outcomes = [
            { title: "HAPPY ENDING", desc: "Hero succeeds, positive resolution" },
            { title: "TRAGEDY", desc: "Hero fails or dies, dramatic conclusion" },
            { title: "REDEMPTION", desc: "Hero overcomes flaws, finds peace" },
            { title: "AMBIGUOUS", desc: "Open-ended, leaves interpretation" },
        ];

        const initialStoryBeats = [];

        // --- Components ---

        const SetupModal = ({ onClose, onGenerate }) => {
            const [currentStep, setCurrentStep] = useState(1);
            const [selectedArch, setSelectedArch] = useState(null);
            const [uploadedImages, setUploadedImages] = useState([]);
            const [selectedOutcome, setSelectedOutcome] = useState(null);
            const [isLoading, setIsLoading] = useState(false);

            const handleNext = () => {
                if (currentStep < 4) {
                    setCurrentStep(currentStep + 1);
                }
            };

            const handleBack = () => {
                if (currentStep > 1) {
                    setCurrentStep(currentStep - 1);
                }
            };

            const handleImageUpload = (e) => {
                const files = Array.from(e.target.files).slice(0, 3);
                const imageUrls = files.map(file => URL.createObjectURL(file));
                setUploadedImages(imageUrls);
            };

            // Beat structures for each archetype
            const HERO_JOURNEY_BEATS = [
                { id: 'ordinaryWorld', label: '1. THE ORDINARY WORLD', desc: 'The hero\'s normal life is established before the adventure begins.' },
                { id: 'callToAdventure', label: '2. THE CALL TO ADVENTURE', desc: 'An inciting incident disrupts the hero\'s comfort zone.' },
                { id: 'refusal', label: '3. REFUSAL OF THE CALL', desc: 'The hero hesitates or resists the journey ahead.' },
                { id: 'meetingMentor', label: '4. MEETING THE MENTOR', desc: 'A guide appears to offer wisdom, tools, or inspiration.' },
                { id: 'crossingThreshold', label: '5. CROSSING THE FIRST THRESHOLD', desc: 'The hero fully commits and steps into the unknown.' },
                { id: 'testsAllies', label: '6. TESTS, ALLIES, ENEMIES', desc: 'The hero faces challenges, gains allies, and identifies adversaries.' },
                { id: 'approach', label: '7. APPROACH TO THE INNERMOST CAVE', desc: 'The hero nears their goal, but danger and uncertainty increase.' },
                { id: 'ordeal', label: '8. THE ORDEAL', desc: 'A critical confrontation forces the hero to face their deepest fears.' },
                { id: 'reward', label: '9. REWARD (SEIZING THE SWORD)', desc: 'The hero earns a tangible or intangible boon after overcoming the ordeal.' },
                { id: 'roadBack', label: '10. THE ROAD BACK', desc: 'The hero begins the journey home, but the story is not yet over.' },
                { id: 'resurrection', label: '11. RESURRECTION', desc: 'The hero faces a final, defining climactic challenge.' },
                { id: 'returnElixir', label: '12. RETURN WITH THE ELIXIR', desc: 'The hero returns to the ordinary world, transformed and bringing new knowledge or strength.' }
            ];

            const SAVE_THE_CAT_BEATS = [
                { id: 'openingImage', label: '1. OPENING IMAGE', desc: 'A snapshot that sets the tone and introduces the protagonist.' },
                { id: 'setup', label: '2. SETUP', desc: 'The world is introduced, establishing relationships and stakes.' },
                { id: 'themeStated', label: '3. THEME STATED', desc: 'The story\'s deeper message or lesson is hinted at.' },
                { id: 'catalyst', label: '4. CATALYST', desc: 'The inciting incident that kicks the story into motion.' },
                { id: 'debate', label: '5. DEBATE', desc: 'The protagonist hesitates or questions the path ahead.' },
                { id: 'breakIntoTwo', label: '6. BREAK INTO TWO', desc: 'The hero commits fully to the central goal, entering Act II.' },
                { id: 'bStory', label: '7. B STORY', desc: 'A subplot emerges, often focusing on an emotional thread like romance or friendship.' },
                { id: 'funAndGames', label: '8. FUN AND GAMES', desc: 'The "promise of the premise" is explored as the hero navigates their new world.' },
                { id: 'midpoint', label: '9. MIDPOINT', desc: 'A major twist or revelation changes the story\'s trajectory.' },
                { id: 'badGuysCloseIn', label: '10. BAD GUYS CLOSE IN', desc: 'Tension ramps up as obstacles and enemies surround the protagonist.' },
                { id: 'allIsLost', label: '11. ALL IS LOST', desc: 'A crushing setback makes the protagonist confront their deepest fears.' },
                { id: 'darkNight', label: '12. DARK NIGHT OF THE SOUL', desc: 'The hero hits rock bottom and questions everything.' },
                { id: 'breakIntoThree', label: '13. BREAK INTO THREE', desc: 'A new insight sparks a path forward into Act III.' },
                { id: 'finale', label: '14. FINALE', desc: 'The climax, where the hero uses everything they\'ve learned to face the final challenge.' },
                { id: 'finalImage', label: '15. FINAL IMAGE', desc: 'A closing snapshot that mirrors the opening image, showing how much the hero has transformed.' }
            ];

            const STORY_CIRCLE_BEATS = [
                { id: 'you', label: '1. YOU (ZONE OF COMFORT)', desc: 'The character is grounded in their mundane and unchallenging everyday life.' },
                { id: 'need', label: '2. NEED (WANT SOMETHING)', desc: 'A core desire compels the protagonist to take action.' },
                { id: 'go', label: '3. GO (ENTER AN UNFAMILIAR SITUATION)', desc: 'The character crosses a threshold to pursue what they want.' },
                { id: 'search', label: '4. SEARCH (ADAPT TO IT)', desc: 'They must acquire new skills and learn how to survive in this new world.' },
                { id: 'find', label: '5. FIND (GET WHAT THEY WANTED)', desc: 'The character achieves their goal, but it comes at a significant cost.' },
                { id: 'take', label: '6. TAKE (PAY A HEAVY PRICE)', desc: 'Victory is followed by new and unexpected losses or sacrifices.' },
                { id: 'return', label: '7. RETURN (RETURN TO FAMILIAR SITUATION)', desc: 'The character goes back to where they started.' },
                { id: 'change', label: '8. CHANGE (HAVING CHANGED)', desc: 'The character has grown, and the lessons learned remain with them.' }
            ];

            const THREE_ACT_BEATS = [
                { id: 'exposition', label: '1. EXPOSITION', desc: 'Establish the protagonist\'s ordinary world.' },
                { id: 'incitingIncident', label: '2. INCITING INCIDENT', desc: 'An event disrupts the ordinary world and kicks off the main story.' },
                { id: 'plotPoint1', label: '3. PLOT POINT 1', desc: 'The protagonist commits to facing the conflict, crossing a threshold into Act II.' },
                { id: 'risingAction', label: '4. RISING ACTION', desc: 'The protagonist faces escalating challenges, and the stakes are raised.' },
                { id: 'midpoint', label: '5. MIDPOINT', desc: 'A major turning point flips the story upside down, often making success feel impossible.' },
                { id: 'plotPoint2', label: '6. PLOT POINT 2', desc: 'The protagonist suffers a major setback, forcing them to question their ability to succeed.' },
                { id: 'preClimax', label: '7. PRE-CLIMAX', desc: 'The protagonist regroups and prepares for the final confrontation.' },
                { id: 'climax', label: '8. CLIMAX', desc: 'The ultimate showdown where the central conflict is finally resolved.' },
                { id: 'denouement', label: '9. DÃ‰NOUEMENT', desc: 'Loose ends are tied up, and the new status quo is revealed.' }
            ];

            const SEVEN_POINT_BEATS = [
                { id: 'hook', label: '1. HOOK', desc: 'Grounds readers in the protagonist\'s world while introducing a spark of intrigue.' },
                { id: 'plotPointOne', label: '2. PLOT POINT ONE', desc: 'The inciting incident that disrupts normal life and pushes the protagonist into the main conflict.' },
                { id: 'pinchPointOne', label: '3. PINCH POINT ONE', desc: 'The first real clash with the antagonist, forcing the protagonist to confront the stakes.' },
                { id: 'midpoint', label: '4. MIDPOINT', desc: 'A major shift in perspective where the protagonist takes full responsibility and begins driving the story.' },
                { id: 'pinchPointTwo', label: '5. PINCH POINT TWO', desc: 'Conflict deepens and hope fades as the protagonist hits their lowest moment.' },
                { id: 'plotPointTwo', label: '6. PLOT POINT TWO', desc: 'A breakthrough where the hero gains new information, tools, or allies that change everything.' },
                { id: 'resolution', label: '7. RESOLUTION', desc: 'The climax and conclusion, where the protagonist\'s journey reaches its peak.' }
            ];

            const LESTER_DENT_BEATS = [
                { id: 'hitWithTrouble', label: '1. HIT THE HERO WITH TROUBLE', desc: 'First line: Hit the hero with their trouble. Expand on the situation and hint at the core problem.' },
                { id: 'jumpIntoAction', label: '2. JUMP INTO ACTION', desc: 'The hero must grapple with the problem head-on from the start.' },
                { id: 'introduceAllies', label: '3. INTRODUCE ALLIES AND COUNTERPARTS', desc: 'Bring in other key characters to engage with the problem.' },
                { id: 'altercation1', label: '4. ALTERCATION 1', desc: 'Trigger a physical conflict to escalate events.' },
                { id: 'achieveMinor', label: '5. ACHIEVE SOMETHING MINOR', desc: 'Allow the hero a small victory, like uncovering a clue or releasing a captive.' },
                { id: 'plotTwist1', label: '6. PLOT TWIST 1', desc: 'End the section with a surprise that reveals something is not what it seems.' },
                { id: 'doubleTrouble', label: '7. DOUBLE THE TROUBLE', desc: 'Dramatically escalate the stakes and tension from Part 1.' },
                { id: 'showStruggle', label: '8. SHOW THE STRUGGLE', desc: 'Depict the hero unsuccessfully grappling with the heightened pressure.' },
                { id: 'altercation2', label: '9. ALTERCATION 2', desc: 'Initiate a second physical conflict, keeping it fresh and distinct from the first.' },
                { id: 'plotTwist2', label: '10. PLOT TWIST 2', desc: 'End with another twist, proving yet another element is not as it seems.' },
                { id: 'ratchetTension', label: '11. RATCHET THE TENSION', desc: 'Push the pressure to its absolute highest point.' },
                { id: 'falseHope', label: '12. PROVIDE FALSE HOPE', desc: 'Offer a temporary glimmer of hope or progress.' },
                { id: 'altercation3', label: '13. ALTERCATION 3', desc: 'Ensure this glimmer of hope leads directly into a third physical conflict.' },
                { id: 'devastatingTwist', label: '14. DEVASTATING TWIST', desc: 'End with a crushing reversal that leaves the hero in an impossible, all-is-lost situation.' },
                { id: 'lastStraw', label: '15. ADD A "LAST STRAW"', desc: 'Push the hero to their absolute lowest point.' },
                { id: 'escapeDefeat', label: '16. ESCAPE AND DEFEAT', desc: 'The hero uses specialist skills to escape and overcome the villain.' },
                { id: 'tieUpLooseEnds', label: '17. TIE UP LOOSE ENDS', desc: 'Resolve all remaining mysteries.' },
                { id: 'finalPlotTwist', label: '18. FINAL PLOT TWIST', desc: 'Deliver one last surprise at the very end.' },
                { id: 'deliverPunchline', label: '19. DELIVER THE PUNCHLINE', desc: 'Conclude with a clever, snappy final line.' }
            ];

            const handleGenerateClick = async () => {
                if (currentStep !== 4) {
                    handleNext();
                    return;
                }

                setIsLoading(true);
                const archetype = archetypes[selectedArch];
                const outcome = outcomes[selectedOutcome];
                
                // Generate all beats based on selected archetype
                setTimeout(() => {
                    let beatStructure = [];
                    
                    // Select the appropriate beat structure
                    if (selectedArch === 0) { // Hero's Journey
                        beatStructure = HERO_JOURNEY_BEATS;
                    } else if (selectedArch === 1) { // Save the Cat
                        beatStructure = SAVE_THE_CAT_BEATS;
                    } else if (selectedArch === 2) { // Story Circle
                        beatStructure = STORY_CIRCLE_BEATS;
                    } else if (selectedArch === 3) { // Three-Act
                        beatStructure = THREE_ACT_BEATS;
                    } else if (selectedArch === 4) { // Seven-Point
                        beatStructure = SEVEN_POINT_BEATS;
                    } else if (selectedArch === 5) { // Lester Dent
                        beatStructure = LESTER_DENT_BEATS;
                    }
                    
                    // Generate beats with visual styling
                    const beats = beatStructure.map((beat, idx) => ({
                        id: idx + 1,
                        label: beat.label,
                        duration: `${(Math.random() * 5 + 3).toFixed(1)}s`,
                        img: `linear-gradient(45deg, #${111 + idx * 10}, #${222 + idx * 5})`,
                        desc: beat.desc,
                        beatId: beat.id
                    }));
                    
                    onGenerate(beats, selectedArch);
                    setIsLoading(false);
                    onClose();
                }, 2000);
            };

            const canProceed = () => {
                if (currentStep === 1) return selectedArch !== null;
                if (currentStep === 2) return uploadedImages.length > 0;
                if (currentStep === 3) return selectedOutcome !== null;
                return true;
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
                    <div className="w-[800px] max-h-[90vh] bg-card border border-border rounded-xl shadow-modal flex flex-col overflow-hidden">
                        
                        {/* Header */}
                        <div className="h-16 border-b border-border flex items-center justify-between px-6 bg-card">
                            <h2 className="text-lg font-bold text-white tracking-wide">CREATE NEW STORY</h2>
                            <button onClick={onClose} className="text-secondary hover:text-white transition-colors">
                                <Icon name="X" size={20} />
                            </button>
                        </div>

                        {/* Steps Indicator */}
                        <div className="h-12 border-b border-border flex items-center justify-center gap-4 bg-[#121215] px-6">
                            {[1, 2, 3, 4].map((step, idx) => (
                                <React.Fragment key={step}>
                                    <div className={`flex items-center gap-2 ${step <= currentStep ? 'text-cyan' : 'text-muted'}`}>
                                        <div className={`w-6 h-6 rounded-full flex items-center justify-center text-[10px] border transition-all ${
                                            step < currentStep 
                                                ? 'border-cyan bg-cyan-dim' 
                                                : step === currentStep 
                                                    ? 'border-cyan bg-cyan-dim font-bold' 
                                                    : 'border-border bg-background'
                                        }`}>
                                            {step < currentStep ? <Icon name="Check" size={10} className="text-cyan" /> : step}
                                        </div>
                                    </div>
                                    {idx < 3 && (
                                        <div className={`w-8 h-[1px] transition-colors ${
                                            step < currentStep ? 'bg-cyan' : 'bg-border'
                                        }`} />
                                    )}
                                </React.Fragment>
                            ))}
                        </div>

                        {/* Content */}
                        <div className="p-8 bg-background flex-1 overflow-y-auto relative">
                            {isLoading && (
                                <div className="absolute inset-0 z-10 bg-black/80 flex flex-col items-center justify-center">
                                    <div className="w-12 h-12 border-2 border-cyan border-t-transparent rounded-full animate-spin mb-4"></div>
                                    <div className="text-cyan font-mono text-sm animate-pulse">GENERATING STORY STRUCTURE...</div>
                                </div>
                            )}

                            {/* STEP 1: Select Narrative Archetype */}
                            {currentStep === 1 && (
                                <div>
                                    <h3 className="text-sm font-bold text-secondary mb-6 uppercase tracking-wider">Step 1: Select Narrative Archetype</h3>
                                    <div className="grid grid-cols-2 gap-4 max-h-[500px] overflow-y-auto">
                                        {archetypes.map((arch, idx) => (
                                            <div 
                                                key={idx}
                                                onClick={() => setSelectedArch(idx)}
                                                className={`
                                                    relative h-[200px] p-6 rounded-lg border-2 cursor-pointer transition-all duration-200 group
                                                    ${selectedArch === idx 
                                                        ? 'border-cyan bg-cyan-dim/20 shadow-glow' 
                                                        : 'border-border bg-background hover:border-cyan/50 hover:bg-card'}
                                                `}
                                            >
                                                <div className="flex justify-between items-start mb-2">
                                                    <h4 className="text-lg font-bold text-white">{arch.title}</h4>
                                                    {selectedArch === idx && <Icon name="Check" className="text-cyan" />}
                                                </div>
                                                <p className="text-xs text-muted font-bold mb-4">{arch.subtitle}</p>
                                                <div className="text-[11px] text-secondary mb-2">{arch.desc}</div>
                                                <div className="text-[10px] text-muted italic mt-4">Like: {arch.example}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* STEP 2: Upload Images */}
                            {currentStep === 2 && (
                                <div>
                                    <h3 className="text-sm font-bold text-secondary mb-6 uppercase tracking-wider">Step 2: Upload Reference Images</h3>
                                    <div className="space-y-4">
                                        {uploadedImages.length === 0 ? (
                                            <label className="block w-full h-[300px] border-2 border-dashed border-border rounded-lg cursor-pointer hover:border-cyan/50 hover:bg-card transition-all flex flex-col items-center justify-center gap-4">
                                                <Icon name="Upload" size={48} className="text-muted" />
                                                <div className="text-center">
                                                    <div className="text-white font-bold mb-1">Drag & Drop Images Here</div>
                                                    <div className="text-[11px] text-muted">Or click to browse (1-3 images max)</div>
                                                </div>
                                                <input 
                                                    type="file" 
                                                    accept="image/*" 
                                                    multiple 
                                                    className="hidden" 
                                                    onChange={handleImageUpload}
                                                />
                                            </label>
                                        ) : (
                                            <div className="grid grid-cols-3 gap-4">
                                                {uploadedImages.map((url, idx) => (
                                                    <div key={idx} className="relative aspect-video rounded-lg overflow-hidden border border-border group">
                                                        <img src={url} alt={`Reference ${idx + 1}`} className="w-full h-full object-cover" />
                                                        <button 
                                                            onClick={() => setUploadedImages(prev => prev.filter((_, i) => i !== idx))}
                                                            className="absolute top-2 right-2 w-6 h-6 bg-red-500/80 hover:bg-red-500 text-white rounded flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
                                                        >
                                                            <Icon name="X" size={12} />
                                                        </button>
                                                        <div className="absolute bottom-2 left-2 bg-black/80 px-2 py-1 text-[10px] text-white rounded">
                                                            {idx + 1}/{uploadedImages.length}
                                                        </div>
                                                    </div>
                                                ))}
                                                {uploadedImages.length < 3 && (
                                                    <label className="aspect-video border-2 border-dashed border-border rounded-lg cursor-pointer hover:border-cyan/50 flex items-center justify-center">
                                                        <Icon name="Plus" size={24} className="text-muted" />
                                                        <input 
                                                            type="file" 
                                                            accept="image/*" 
                                                            multiple 
                                                            className="hidden" 
                                                            onChange={handleImageUpload}
                                                        />
                                                    </label>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* STEP 3: Select Outcome */}
                            {currentStep === 3 && (
                                <div>
                                    <h3 className="text-sm font-bold text-secondary mb-6 uppercase tracking-wider">Step 3: Select Story Outcome</h3>
                                    <div className="space-y-3">
                                        {outcomes.map((outcome, idx) => (
                                            <div 
                                                key={idx}
                                                onClick={() => setSelectedOutcome(idx)}
                                                className={`
                                                    p-4 rounded-lg border-2 cursor-pointer transition-all
                                                    ${selectedOutcome === idx 
                                                        ? 'border-cyan bg-cyan-dim/20 shadow-glow' 
                                                        : 'border-border bg-background hover:border-cyan/50'}
                                                `}
                                            >
                                                <div className="flex items-center justify-between">
                                                    <div>
                                                        <div className="flex items-center gap-3 mb-1">
                                                            <div className={`w-4 h-4 rounded-full border-2 flex items-center justify-center ${
                                                                selectedOutcome === idx ? 'border-cyan bg-cyan' : 'border-border'
                                                            }`}>
                                                                {selectedOutcome === idx && <div className="w-2 h-2 bg-black rounded-full"></div>}
                                                            </div>
                                                            <h4 className="text-sm font-bold text-white">{outcome.title}</h4>
                                                        </div>
                                                        <p className="text-[11px] text-muted ml-7">{outcome.desc}</p>
                                                    </div>
                                                    {selectedOutcome === idx && <Icon name="Check" className="text-cyan" />}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* STEP 4: Review & Generate */}
                            {currentStep === 4 && (
                                <div>
                                    <h3 className="text-sm font-bold text-secondary mb-6 uppercase tracking-wider">Step 4: Review & Generate</h3>
                                    <div className="space-y-4">
                                        <div className="p-4 border border-border rounded-lg bg-background">
                                            <div className="text-[10px] text-muted uppercase mb-2">Selected Archetype</div>
                                            <div className="text-sm font-bold text-white">{archetypes[selectedArch]?.title}</div>
                                        </div>
                                        <div className="p-4 border border-border rounded-lg bg-background">
                                            <div className="text-[10px] text-muted uppercase mb-2">Reference Images</div>
                                            <div className="text-sm text-secondary">{uploadedImages.length} image{uploadedImages.length !== 1 ? 's' : ''} uploaded</div>
                                        </div>
                                        <div className="p-4 border border-border rounded-lg bg-background">
                                            <div className="text-[10px] text-muted uppercase mb-2">Story Outcome</div>
                                            <div className="text-sm font-bold text-white">{outcomes[selectedOutcome]?.title}</div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="h-16 border-t border-border flex items-center justify-between px-6 bg-card">
                            <button 
                                onClick={handleBack}
                                disabled={currentStep === 1}
                                className={`px-6 py-2 border border-border rounded text-secondary text-xs hover:text-white hover:border-secondary transition-colors uppercase ${
                                    currentStep === 1 ? 'opacity-50 cursor-not-allowed' : ''
                                }`}
                            >
                                Back
                            </button>
                            <button 
                                onClick={handleGenerateClick} 
                                disabled={!canProceed() || isLoading}
                                className={`px-6 py-2 bg-cyan text-black font-bold text-xs rounded hover:bg-teal transition-colors uppercase flex items-center gap-2 ${
                                    (!canProceed() || isLoading) ? 'opacity-50 cursor-not-allowed' : ''
                                }`}
                            >
                                {isLoading ? 'Processing...' : currentStep === 4 ? 'Generate Story' : 'Next'} 
                                {currentStep === 4 && <Icon name="Sparkles" size={14} />}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const BranchPanel = ({ parentBeat, onClose }) => {
            const [options, setOptions] = useState([
                { id: 1, title: "PATH A: CONFRONTATION", duration: "+12s", desc: "The hero faces the antagonist directly.", type: "action", selected: false },
                { id: 2, title: "PATH B: RETREAT", duration: "+8s", desc: "The hero withdraws to regroup and plan.", type: "strategy", selected: false },
                { id: 3, title: "PATH C: NEGOTIATION", duration: "+10s", desc: "The hero attempts to find a peaceful solution.", type: "dialogue", selected: false }
            ]);
            const [isGenerating, setIsGenerating] = useState(false);

            const handleAddOption = async () => {
                setIsGenerating(true);
                setTimeout(() => {
                    setOptions(prev => [...prev, { 
                        id: Date.now(), 
                        title: `PATH ${String.fromCharCode(65 + prev.length)}: NEW PATH`, 
                        duration: "+8s", 
                        desc: "An alternative story direction.",
                        type: "dialogue",
                        selected: false
                    }]);
                    setIsGenerating(false);
                }, 1000);
            };

            const handleSelectPath = (pathId) => {
                setOptions(prev => prev.map(opt => ({ ...opt, selected: opt.id === pathId })));
            };

            return (
                <>
                    {/* Visual connector line */}
                    <div className="absolute top-1/2 left-full w-16 h-[2px] bg-cyan z-10" style={{ transform: 'translateY(-50%)' }}>
                        <div className="absolute right-0 top-1/2 -translate-y-1/2 w-2 h-2 bg-cyan rounded-full"></div>
                    </div>
                    
                    {/* Branch panel - slides out to the right */}
                    <div className="absolute top-0 left-[calc(100%+64px)] w-[500px] bg-card border border-cyan/50 rounded-lg shadow-2xl z-20 flex flex-col" style={{ 
                        animation: 'slideInRight 0.3s ease-out forwards',
                        maxHeight: '80vh'
                    }}>
                        <style>{`
                            @keyframes slideInRight {
                                from { transform: translateX(-20px); opacity: 0; }
                                to { transform: translateX(0); opacity: 1; }
                            }
                        `}</style>
                        
                        <div className="h-12 border-b border-border flex items-center justify-between px-4 bg-card rounded-t-lg">
                            <div className="flex items-center gap-2">
                                <Icon name="GitBranch" size={16} className="text-cyan" />
                                <span className="text-[13px] font-bold text-white uppercase">Story Branches</span>
                                <span className="text-[10px] text-muted ml-2">from {parentBeat.label}</span>
                            </div>
                            <button onClick={onClose} className="text-muted hover:text-white transition-colors">
                                <Icon name="X" size={16} />
                            </button>
                        </div>

                        <div className="p-4 overflow-y-auto flex-1 bg-background">
                            <div className="mb-3 text-[10px] text-muted uppercase tracking-wider">
                                Choose how the story continues:
                            </div>
                            
                            {options.map((opt, i) => (
                                <div 
                                    key={opt.id} 
                                    onClick={() => handleSelectPath(opt.id)}
                                    className={`mb-3 border-2 rounded-lg p-3 transition-all cursor-pointer group ${
                                        opt.selected 
                                            ? 'border-cyan bg-cyan-dim/20 shadow-glow' 
                                            : 'border-border bg-background hover:border-cyan/50 hover:bg-card'
                                    }`}
                                >
                                    <div className="flex items-start justify-between mb-2">
                                        <div className="flex items-center gap-2">
                                            <div className={`w-3 h-3 rounded-full border-2 flex items-center justify-center ${
                                                opt.selected ? 'border-cyan bg-cyan' : 'border-border'
                                            }`}>
                                                {opt.selected && <div className="w-1.5 h-1.5 bg-black rounded-full"></div>}
                                            </div>
                                            <span className={`text-[11px] font-bold ${
                                                opt.selected ? 'text-cyan' : 'text-secondary group-hover:text-cyan'
                                            }`}>
                                                {opt.title}
                                            </span>
                                        </div>
                                        <span className="text-[10px] text-muted">+{opt.duration}</span>
                                    </div>
                                    <div className="text-[10px] text-muted mb-3 ml-5 font-sans italic">
                                        "{opt.desc}"
                                    </div>
                                    <div className="grid grid-cols-3 gap-2 ml-5">
                                        {Array(3).fill(0).map((_, k) => (
                                            <div key={k} className="aspect-video bg-black border border-border rounded opacity-40 group-hover:opacity-60 transition-opacity">
                                                <div className="w-full h-full flex items-center justify-center text-[8px] text-muted">KF {k+1}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}

                            {isGenerating && (
                                <div className="mb-3 p-4 border border-dashed border-cyan/30 rounded flex items-center justify-center gap-3">
                                    <div className="w-4 h-4 border border-cyan border-t-transparent rounded-full animate-spin"></div>
                                    <span className="text-[10px] text-cyan animate-pulse">GENERATING NEW PATH...</span>
                                </div>
                            )}
                            
                            {options.length < 4 && (
                                <button 
                                    onClick={handleAddOption}
                                    disabled={isGenerating}
                                    className="w-full py-2.5 border border-dashed border-cyan/30 bg-cyan-dim/10 text-cyan text-[10px] rounded hover:bg-cyan-dim/20 hover:border-cyan/60 uppercase tracking-widest transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    <Icon name="Sparkles" size={12} /> Generate Branch Option
                                </button>
                            )}
                        </div>
                    </div>
                </>
            );
        };

        const MainInterface = () => {
            const [storyBeats, setStoryBeats] = useState(initialStoryBeats);
            const [selectedCard, setSelectedCard] = useState(null);
            const [showModal, setShowModal] = useState(true);
            const [timelineClips, setTimelineClips] = useState([]);
            const [selectedArchetype, setSelectedArchetype] = useState(null);

            useEffect(() => {
                setTimelineClips(Array(8).fill(null).map((_, i) => ({
                    id: i,
                    width: Math.floor(Math.random() * (120 - 60 + 1) + 60) + 'px'
                })));
            }, []);

            return (
                <div className="h-screen w-screen flex flex-col bg-background text-primary selection:bg-cyan selection:text-black">
                    
                    {showModal && (
                        <SetupModal 
                            onClose={() => setShowModal(false)} 
                            onGenerate={(beats, archIdx) => {
                                setStoryBeats(beats);
                                setSelectedArchetype(archIdx);
                                setShowModal(false);
                            }}
                        />
                    )}

                    {/* HEADER */}
                    <header className="h-[56px] w-full border-b border-border bg-background flex items-center justify-between px-4 z-10">
                        <div className="flex items-center gap-3">
                            <div className="text-cyan">
                                <Icon name="Film" size={16} />
                            </div>
                            <h1 className="text-[14px] font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan to-teal tracking-widest">
                                STORYCEPTION
                            </h1>
                        </div>
                        
                        <div className="text-[12px] text-muted font-bold tracking-wide">
                            AI_POWERED_SESSION_01
                        </div>

                        <button 
                            onClick={() => setShowModal(true)}
                            className="text-[11px] px-3 py-1.5 border border-cyan/50 text-cyan hover:bg-cyan hover:text-black transition-all rounded-sm uppercase tracking-wide font-bold flex items-center gap-2"
                        >
                            <Icon name="Plus" size={12} /> New Story
                        </button>
                    </header>

                    {/* MAIN CANVAS */}
                    <main className="flex-1 overflow-y-auto overflow-x-hidden relative p-8">
                        <div className="max-w-7xl mx-auto">
                            <div className="flex flex-col items-center gap-6">
                                {storyBeats.map((beat, idx) => (
                                    <div key={beat.id} className="relative w-full flex justify-center">
                                        {/* Story beat card */}
                                        <div 
                                            className={`
                                                relative w-[500px] h-[280px] rounded-lg border-2 transition-all duration-300 group
                                                ${selectedCard === beat.id ? 'border-cyan shadow-glow ring-2 ring-cyan/50 scale-[1.02]' : 'border-border hover:border-cyan/30'}
                                            `}
                                            style={{ background: beat.img }}
                                            onClick={() => setSelectedCard(beat.id === selectedCard ? null : beat.id)}
                                        >
                                            {selectedCard === beat.id && (
                                                <BranchPanel 
                                                    parentBeat={beat}
                                                    onClose={(e) => {
                                                        e?.stopPropagation();
                                                        setSelectedCard(null);
                                                    }} 
                                                />
                                            )}

                                            <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent rounded-lg"></div>

                                            <div className="absolute top-3 right-3 px-2 py-1 bg-black/80 border border-white/10 rounded text-[10px] text-secondary font-mono backdrop-blur-sm">
                                                {beat.duration}
                                            </div>

                                            <div className="absolute top-3 left-3 right-16 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                                <div className="bg-black/90 text-[10px] text-gray-300 p-2 rounded border border-white/10 backdrop-blur-md max-w-[300px]">
                                                    {beat.desc || "No description generated."}
                                                </div>
                                            </div>

                                            <div className="absolute bottom-0 left-0 w-full p-4">
                                                <div className="text-[13px] font-bold text-white uppercase tracking-wider mb-2">
                                                    {beat.label}
                                                </div>
                                                <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                     <button 
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            setSelectedCard(beat.id === selectedCard ? null : beat.id);
                                                        }}
                                                        className="text-[10px] bg-cyan text-black px-3 py-1 rounded font-bold uppercase flex items-center gap-1 hover:bg-teal transition-colors"
                                                     >
                                                        <Icon name="GitBranch" size={10} strokeWidth={3} />
                                                        {selectedCard === beat.id ? 'Close Branches' : 'View Branches'}
                                                     </button>
                                                     <button className="text-[10px] bg-white/10 text-white px-3 py-1 rounded font-bold uppercase hover:bg-white/20 transition-colors">
                                                        Edit
                                                     </button>
                                                </div>
                                            </div>

                                            {selectedCard === beat.id && (
                                                <div className="absolute -left-4 top-1/2 -translate-y-1/2 w-2 h-12 bg-cyan shadow-[0_0_15px_#06b6d4] rounded-full"></div>
                                            )}
                                        </div>
                                        
                                        {/* Branch indicator when selected */}
                                        {selectedCard === beat.id && (
                                            <div className="absolute left-[calc(50%+280px)] top-1/2 -translate-y-1/2 text-[10px] text-cyan font-bold uppercase tracking-wider opacity-75">
                                                Branches â†’
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </main>

                    {/* TIMELINE */}
                    <div className="h-[200px] bg-card border-t border-border flex flex-col z-10 shrink-0">
                        <div className="h-[48px] border-b border-border flex items-center justify-between px-4 bg-card">
                            <div className="flex items-center gap-4">
                                <button className="w-8 h-8 bg-white rounded flex items-center justify-center hover:bg-cyan transition-colors">
                                    <Icon name="Play" size={16} className="text-black ml-0.5" fill="black" />
                                </button>
                                <div className="flex flex-col">
                                    <span className="text-[11px] font-mono text-secondary">00:12:05 <span className="text-muted">/ 00:45:00</span></span>
                                </div>
                            </div>

                            <div className="flex items-center gap-4">
                                <button className="flex items-center gap-2 px-2 py-1 bg-cyan-dim border border-cyan/30 rounded text-[10px] text-cyan uppercase tracking-wide hover:bg-cyan/20">
                                    <Icon name="Shuffle" size={10} /> Shuffle
                                </button>
                                <div className="flex items-center gap-2 text-muted border-l border-border pl-4">
                                    <button className="hover:text-white"><Icon name="Minus" size={14} /></button>
                                    <div className="w-16 h-1 bg-[#27272a] rounded-full overflow-hidden">
                                        <div className="w-1/2 h-full bg-secondary"></div>
                                    </div>
                                    <button className="hover:text-white"><Icon name="Plus" size={14} /></button>
                                </div>
                            </div>
                        </div>

                        <div className="h-[32px] bg-background border-b border-border relative overflow-hidden flex items-end">
                            {Array(20).fill(0).map((_, i) => (
                                <div key={i} className="flex-1 h-full border-l border-white/5 relative group">
                                    <span className="absolute top-1 left-1 text-[9px] text-muted font-mono">{i * 5}s</span>
                                    <div className="absolute bottom-0 left-0 w-[1px] h-2 bg-muted"></div>
                                    <div className="absolute bottom-0 left-1/2 w-[1px] h-1 bg-muted/30"></div>
                                </div>
                            ))}
                            
                            <div className="absolute top-0 bottom-0 left-[30%] w-[1px] bg-yellow z-20 shadow-[0_0_8px_#fbbf24]">
                                <div className="absolute -top-0 -translate-x-1/2 text-yellow">
                                    <svg width="10" height="10" viewBox="0 0 10 10">
                                        <path d="M0 0 L10 0 L5 8 Z" fill="#fbbf24" />
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 bg-[#121215] overflow-x-auto hide-scroll flex items-center px-4 relative">
                            <div className="flex gap-1 items-center relative">
                                {timelineClips.map((clip, i) => (
                                    <div 
                                        key={clip.id}
                                        style={{ width: clip.width }}
                                        className={`
                                            h-[96px] bg-card border-2 rounded relative group overflow-hidden flex-shrink-0
                                            ${i === 2 ? 'border-cyan ring-1 ring-cyan/30' : 'border-border hover:border-secondary'}
                                        `}
                                    >
                                        <div className="absolute inset-0 bg-gradient-to-br from-transparent to-black/50"></div>
                                        <div className="absolute top-1 left-1 text-[8px] text-white/70 font-bold">C_{i+1}</div>
                                        
                                        <div className="absolute bottom-2 left-0 right-0 h-4 flex items-end gap-[1px] px-1 opacity-50">
                                            {Array(10).fill(0).map((_, w) => (
                                                <div key={w} className="flex-1 bg-cyan" style={{ height: Math.random() * 100 + '%' }}></div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                                <div className="absolute top-0 bottom-0 left-[30vw] w-[2px] bg-yellow/50 pointer-events-none z-10"></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MainInterface />);
    </script>
</body>
</html>
